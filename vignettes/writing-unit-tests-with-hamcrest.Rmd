---
title: "Writing unit tests with Hamcrest"
author: "BeDataDriven B.V."
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{Writing unit tests with Hamcrest}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", eval = FALSE)
```

## Introduction

*hamcrest* is a unit test framework originally developed for Java and already
implemented in more than 30 programming languages[^1].

Although it seems that a "yet another test runner" might be too much for **R**;
however, this package is clearly intended for the developers who are familiar
with the *hamcrest* syntax and do not prefer to bother learning a new unit
testing framework such as *testthat* or *RUnit*.

Historically, *hamcrest* is extensively used in **Renjin**, a JVM-based
interpreter for **R**. Take a look at <http://www.renjin.org> for more details.

The **R** version of the *hamcrest* package provides a
*minimal* implementation from the original. 

This vignette briefly explains how to write unit tests
with *hamcrest* package for your package or project.

## Testing basics

The structure of a test consists of two parts:

+ Assertion

+ Matcher

### Assertion

#### assertThat

The common structure of assertThat as follows:
```{r}
assertThat({{actual}}, `matcherFun`({{expected}}))
```

where

+ `actual`: actual object to be matched

+ `expected`: expected object to match

+ `matcherFun`: A matcher function to check the result against the actual object

See `Matchers` section below for available matcher calls.

There are also less central assertions such as `assertTrue` and `assertFalse`
exists, and they can be used as a shortcut for `assertThat(expected, isTrue())`
and `assertThat(expected, isFalse())` respectively.

### Matcher

hamcrest comes with a set of useful matchers.

#### closeTo

Checks if the expected value is close to a value within some tolerance level

```{r}
assertThat(-0.50557992900139, closeTo(-0.50557, delta = 1e4))
```

#### equalTo

Checks if the expected value is equal to a value

```{r}
assertThat(qnorm(0, 0, 1, TRUE, FALSE), equalTo(-Inf))
```

#### identicalTo

Checks if the expected value is identical to a value

```{r}
assertThat(floor(-1.5), identicalTo(-2))
```

#### isTrue

Checks if the expected value is true

```{r}
assertThat(is.integer(1L), isTrue())
```

#### isFalse

Checks if the expected value is false

```{r}
assertThat(is.character(seq(10)), isFalse())
```

#### instanceOf

Checks if the expected value is instance of a value

```{r}
res <- lm(Petal.Length ~ Petal.Width, iris)
assertThat(res, instanceOf("lm"))
```

#### deparsesTo

Checks if the expected value deparses to a value

```{r}
assertThat(unlist(quote(sin(3.14)), recursive = FALSE), deparsesTo("sin(3.14)"))
```

#### emitsWarning

Checks if the expected value emits warning(s)

```{r}
assertThat(any(range(2.0,3.0)), emitsWarning())
```

#### throwsError

Checks if the expected value throws (any) error

```{r}
assertThat(log("a"), throwsError())
```

### Other methods

#### not

`not` is a logical method negates the result of matcher function. It can only be
used with the matcher function.

```{r}
assertThat(1, not(identicalTo(2)))
```

## Using hamcrest in packages

The easiest way to use `hamcrest` in your package is to create test files in the
`tests` folder where you keep all your *hamcrest* tests.

For instance;

- Create a file e.g. `validation-test.R`

- Put the assertions inside the `test_hamcrest` function. This allows you to
easily distinguish the assertions, and keep those which are related to each
other together

- Run the tests by sourcing the file such as `
 you can put the individual tests inside the `test_hamcrest` block.

```{r}
test_hamcrest("test numbers", {
  set.seed(2019)
  num <- rnorm(5)
  assertThat(num, closeTo(c(0.738522661252181,
                            -0.514760490807001,
                            -1.64018134225737,
                            0.916036784965901,
                            -1.26748197407977),
                          delta = 1e4))
})
```

When you call `R CMD check .` in the package directory, all tests will be
automatically run along with the other checks.

## Writing custom matchers

It is very possible to extend hamcrest by adding new assertions and matchers.
For instance;

You can write a custom matcher like this:

```{r}
isDate <- function() {
  function(actual) {
        inherits(actual, "Date")
    }
}
assertThat(Sys.Date(), isDate())
```

Write a custom assertion (to make it more modular, we write the matcher separately):

```{r}
isEvenInteger <- function() {
  function(actual) {
    actual %% 2L == 0L
  }
}

assertEvenInteger <- function(value) {
  if(!assertThat(value, isEvenInteger())) {
    throw_assert_error(value)
  }
}
```

## Hamcrest in Renjin

For more information about how **Renjin** uses *hamcrest* to write unit tests,
please see the
[**Using the hamcrest package to write unit tests**](http://docs.renjin.org/en/latest/writing-renjin-extensions.html#using-the-hamcrest-package-to-write-unit-tests)
documentation post[^2].

[^1]: Check the original hamcrest website: <http://hamcrest.org/>.
[^2]: Access to **Renjin** documentation via <http://docs.renjin.org/>.
